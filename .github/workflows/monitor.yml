name: Release Observer

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: read

env:
  # Target Repository
  TARGET_REPO: topjohnwu/Magisk
  STATE_FILE: last_release_tag.txt

jobs:
  release-monitor:
    runs-on: ubuntu-latest
    steps:
      - name: State Restoration
        uses: actions/cache/restore@v4
        id: restore-state
        with:
          path: ${{ env.STATE_FILE }}
          key: release-state-${{ github.run_id }}
          restore-keys: |
            release-state-

      - name: Fetch Latest Release
        id: fetch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo ">>> Checking latest release for: ${{ env.TARGET_REPO }}"
          
          # Fetch Latest Release Data via API
          RELEASE_DATA=$(gh api "repos/${{ env.TARGET_REPO }}/releases/latest")
          
          # Extract Key Info
          TAG_NAME=$(echo "$RELEASE_DATA" | jq -r .tag_name)
          RELEASE_URL=$(echo "$RELEASE_DATA" | jq -r .html_url)
          TITLE=$(echo "$RELEASE_DATA" | jq -r .name)
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT

          # Save assets to temp file for processing
          echo "$RELEASE_DATA" | jq .assets > assets.json
          
          # Check Cache (Deduplication Logic)
          if [ -f "${{ env.STATE_FILE }}" ]; then
            PREV_TAG=$(cat ${{ env.STATE_FILE }})
          else
            PREV_TAG="none"
          fi
          
          echo "Current Version: $TAG_NAME"
          echo "Cached Version:  $PREV_TAG"
          
          if [ "$TAG_NAME" == "$PREV_TAG" ]; then
            echo "status=duplicate" >> $GITHUB_OUTPUT
            echo ">>> Version unchanged. Standing by."
          else
            echo "status=new" >> $GITHUB_OUTPUT
            echo ">>> New release detected!"
          fi

      - name: Process Assets (Convert Bytes to MB)
        id: assets
        if: steps.fetch.outputs.status == 'new'
        run: |
          COUNT=$(jq length assets.json)
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          
          if [ "$COUNT" -gt "0" ]; then
            # Logic: Size / 1024 / 1024 = MB. Rounded to 2 decimal places.
            LIST=$(jq -r '.[] | "- [" + .name + "](" + .browser_download_url + ") (" + ((.size / 1048576 * 100 | floor / 100) | tostring) + " MB)"' assets.json)
            
            echo "asset_list<<EOF" >> $GITHUB_OUTPUT
            echo "$LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
             echo "asset_list=No assets found." >> $GITHUB_OUTPUT
          fi

      - name: Notify Telegram
        if: steps.fetch.outputs.status == 'new'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            *ðŸŽ‰ New Release Detected!*
            
            *Repo:* `${{ env.TARGET_REPO }}`
            *Version:* `${{ steps.fetch.outputs.tag_name }}`
            *Title:* ${{ steps.fetch.outputs.title }}
            
            *Download Links:*
            ${{ steps.assets.outputs.asset_list }}
            
            [View Release Page](${{ steps.fetch.outputs.release_url }})

      - name: Update State File
        if: steps.fetch.outputs.status == 'new'
        run: echo "${{ steps.fetch.outputs.tag_name }}" > ${{ env.STATE_FILE }}

      - name: Save State to Cache
        if: steps.fetch.outputs.status == 'new'
        uses: actions/cache/save@v4
        with:
          path: ${{ env.STATE_FILE }}
          key: release-state-${{ github.run_id }}
