name: CI/CD Pipeline Observer

on:
  schedule:
    - cron: "*/15 * * * *" # Run every 15 minutes
  workflow_dispatch: # Manual trigger

env:
  TARGET_REPO: "JingMatrix/LSPosed"
  WORKFLOW_FILENAME: "ci.yml"
  STATE_FILE: "last_processed_commit.txt"

jobs:
  observability-engine:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”„ State Restoration (Cache)
        uses: actions/cache/restore@v4
        id: restore-state
        with:
          path: ${{ env.STATE_FILE }}
          # Logic: Restore cache terbaru yang punya prefix "observer-state-"
          key: observer-state-${{ github.run_id }} 
          restore-keys: |
            observer-state-

      - name: ðŸ”Ž Fetch Latest Artifact Build
        id: fetch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo ">>> Querying GitHub API for latest successful run..."
          
          # Fetch latest successful run with artifacts
          LATEST_RUN=$(gh api "repos/${{ env.TARGET_REPO }}/actions/runs" \
            -F status=success \
            -F event=push \
            -F per_page=1 \
            --jq '.workflow_runs[0]')

          COMMIT_SHA=$(echo "$LATEST_RUN" | jq -r .head_sha)
          RUN_ID=$(echo "$LATEST_RUN" | jq -r .id)
          ARTIFACTS_URL=$(echo "$LATEST_RUN" | jq -r .artifacts_url)
          
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "artifacts_url=$ARTIFACTS_URL" >> $GITHUB_OUTPUT
          
          # Read previous state
          if [ -f "${{ env.STATE_FILE }}" ]; then
            PREV_COMMIT=$(cat ${{ env.STATE_FILE }})
          else
            PREV_COMMIT="none"
          fi
          
          echo "Current: $COMMIT_SHA"
          echo "Cached:  $PREV_COMMIT"
          
          if [ "$COMMIT_SHA" == "$PREV_COMMIT" ]; then
            echo "status=duplicate" >> $GITHUB_OUTPUT
            echo ">>> No new changes detected. Standing by."
          else
            echo "status=new" >> $GITHUB_OUTPUT
            echo ">>> New build detected! Proceeding to analysis."
          fi

      - name: ðŸ“¦ Artifact Inspection
        id: inspect
        if: steps.fetch.outputs.status == 'new'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if artifacts actually exist
          ARTIFACTS=$(gh api "${{ steps.fetch.outputs.artifacts_url }}" --jq '.artifacts')
          COUNT=$(echo "$ARTIFACTS" | jq length)
          
          if [ "$COUNT" -gt "0" ]; then
            echo "has_artifacts=true" >> $GITHUB_OUTPUT
            echo "count=$COUNT" >> $GITHUB_OUTPUT
            
            # Format list for Telegram
            LIST=$(echo "$ARTIFACTS" | jq -r '.[] | "- " + .name + " (" + (.size_in_bytes | tostring) + " bytes)"')
            
            # Save multiline string safely
            echo "artifact_list<<EOF" >> $GITHUB_OUTPUT
            echo "$LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_artifacts=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸš€ Notification Dispatch (Telegram)
        if: steps.fetch.outputs.status == 'new' && steps.inspect.outputs.has_artifacts == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            *ðŸš€ New Build Detected!*
            
            *Repository:* `${{ env.TARGET_REPO }}`
            *Commit:* `${{ steps.fetch.outputs.commit_sha }}`
            *Artifacts Found:* ${{ steps.inspect.outputs.count }}
            
            *Files:*
            ${{ steps.inspect.outputs.artifact_list }}
            
            [View Workflow Run](https://github.com/${{ env.TARGET_REPO }}/actions/runs/${{ steps.fetch.outputs.run_id }})

      - name: ðŸ’¾ Update State (Rolling Cache)
        if: steps.fetch.outputs.status == 'new'
        uses: actions/cache/save@v4
        with:
          path: ${{ env.STATE_FILE }}
          # KUNCI RAHASIA: Simpan dengan key baru setiap kali jalan
          key: observer-state-${{ github.run_id }}
        run: echo "${{ steps.fetch.outputs.commit_sha }}" > ${{ env.STATE_FILE }}