name: CI/CD Pipeline Observer

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

env:
  # HAPUS TANDA KUTIP AGAR AMAN
  TARGET_REPO: LSPosed/LSPosed
  WORKFLOW_FILENAME: ci.yml
  STATE_FILE: last_processed_commit.txt

jobs:
  observability-engine:
    runs-on: ubuntu-latest
    steps:
      - name: State Restoration Cache
        uses: actions/cache/restore@v4
        id: restore-state
        with:
          path: ${{ env.STATE_FILE }}
          key: observer-state-${{ github.run_id }}
          restore-keys: |
            observer-state-

      - name: Fetch Latest Artifact Build
        id: fetch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # --- DEBUGGING START ---
          echo "DETEKTIF: Memeriksa target repository..."
          echo "Target Saat Ini: [${{ env.TARGET_REPO }}]"
          # --- DEBUGGING END ---

          echo ">>> Querying GitHub API..."
          LATEST_RUN=$(gh api "repos/${{ env.TARGET_REPO }}/actions/runs" \
            -F status=success \
            -F event=push \
            -F per_page=1 \
            --jq '.workflow_runs[0]')

          # Cek jika respon kosong (Repo tidak ketemu/Token error)
          if [ -z "$LATEST_RUN" ] || [ "$LATEST_RUN" == "null" ]; then
            echo "FATAL ERROR: Tidak bisa menemukan data run dari repo ${{ env.TARGET_REPO }}"
            echo "Kemungkinan penyebab: Repo salah tulis, Repo Private, atau Token dibatasi."
            exit 1
          fi

          COMMIT_SHA=$(echo "$LATEST_RUN" | jq -r .head_sha)
          RUN_ID=$(echo "$LATEST_RUN" | jq -r .id)
          ARTIFACTS_URL=$(echo "$LATEST_RUN" | jq -r .artifacts_url)
          
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "artifacts_url=$ARTIFACTS_URL" >> $GITHUB_OUTPUT
          
          if [ -f "${{ env.STATE_FILE }}" ]; then
            PREV_COMMIT=$(cat ${{ env.STATE_FILE }})
          else
            PREV_COMMIT="none"
          fi
          
          if [ "$COMMIT_SHA" == "$PREV_COMMIT" ]; then
            echo "status=duplicate" >> $GITHUB_OUTPUT
          else
            echo "status=new" >> $GITHUB_OUTPUT
          fi

      - name: Artifact Inspection
        id: inspect
        if: steps.fetch.outputs.status == 'new'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ARTIFACTS=$(gh api "${{ steps.fetch.outputs.artifacts_url }}" --jq '.artifacts')
          COUNT=$(echo "$ARTIFACTS" | jq length)
          
          if [ "$COUNT" -gt "0" ]; then
            echo "has_artifacts=true" >> $GITHUB_OUTPUT
            echo "count=$COUNT" >> $GITHUB_OUTPUT
            LIST=$(echo "$ARTIFACTS" | jq -r '.[] | "- " + .name + " (" + (.size_in_bytes | tostring) + " bytes)"')
            echo "artifact_list<<EOF" >> $GITHUB_OUTPUT
            echo "$LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_artifacts=false" >> $GITHUB_OUTPUT
          fi

      - name: Notification Dispatch Telegram
        if: steps.fetch.outputs.status == 'new' && steps.inspect.outputs.has_artifacts == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            *New Build Detected!*
            
            *Repository:* `${{ env.TARGET_REPO }}`
            *Commit:* `${{ steps.fetch.outputs.commit_sha }}`
            *Artifacts Found:* ${{ steps.inspect.outputs.count }}
            
            *Files:*
            ${{ steps.inspect.outputs.artifact_list }}
            
            [View Workflow Run](https://github.com/${{ env.TARGET_REPO }}/actions/runs/${{ steps.fetch.outputs.run_id }})

      - name: Write State File
        if: steps.fetch.outputs.status == 'new'
        run: echo "${{ steps.fetch.outputs.commit_sha }}" > ${{ env.STATE_FILE }}

      - name: Save State to Cache
        if: steps.fetch.outputs.status == 'new'
        uses: actions/cache/save@v4
        with:
          path: ${{ env.STATE_FILE }}
          key: observer-state-${{ github.run_id }}
